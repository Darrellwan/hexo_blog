name: Twitter Post on New Article

on:
  push:
    branches:
      - dev-action-new-x-post

jobs:
  tweet-new-article:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Install Python dependencies
      run: |
        pip install tweepy PyYAML

    - name: Check for New Markdown Files
      id: check-new-md-files
      run: |
        echo "Total commits: $(git rev-list --count HEAD)"
        if [ $(git rev-list --count HEAD) -gt 1 ]; then
          LAST_COMMIT=$(git rev-parse HEAD)
          SECOND_LAST_COMMIT=$(git rev-parse HEAD~1)
          echo "Last commit: $LAST_COMMIT"
          echo "Second last commit: $SECOND_LAST_COMMIT"
          NEW_FILES=$(git diff --name-only --diff-filter=A $SECOND_LAST_COMMIT $LAST_COMMIT -- '*.md')
          echo "::set-output name=new_files::${NEW_FILES}"
          echo "New markdown files: $NEW_FILES"
        else
          echo "Not enough commits to compare."
          echo "::set-output name=new_files::"
        fi

    - name: Process and Tweet New Articles
      if: steps.check-new-md-files.outputs.new_files
      run: python tweet_new_article.py
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
